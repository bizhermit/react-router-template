# AGENTS.md

## 役割

このAGENTは本リポジトリにおいて以下を行う。

- コードの生成・修正
- テストの追加・修正
- ドキュメントの更新

## 基本方針

- コメントは**必ず（MUST）**日本語で記述する
  - ただし、API 名・型名・用語として定着している英語はそのまま使用してよい

## プロジェクト概要

本プロジェクトの目的、提供機能、基本的な利用方法は[README.md](README.md)を参照。

## ガードレール／禁止事項

- ワークスペース外へファイルアクセスを禁止する
- ワークスペース外に影響を与えるコマンドの実行を禁止する
- 秘密情報（APIキー、トークン、認証情報）を追加しない

## 変更ポリシー

- 既存仕様の変更・削除は、明示的な指示がない限り行わない
- 既存コードの設計意図を尊重し、変更範囲は最小限に保つ

### 既存実装の理解

- 変更対象に既存コードがある場合、まず設計意図を読み取ること
- コメント・命名・テストは、いずれも設計意図の一部として扱う
- 意図が不明確な場合は、推測で変更せず確認を求める

### 破壊的変更

- 公開 API・型定義・外部から観測可能な振る舞いに影響する変更は、破壊的変更とみなす
- 破壊的変更を行う場合は、事前の明示的な指示を必須とする
- 影響範囲は Commit message または PR に明記する

## 作業フロー

### 大規模変更時の進め方

- 影響範囲が広い変更の場合、実装前に変更方針を簡潔に整理する
- 指示がない限り、変更は段階的かつ最小単位で行う

### 変更提案フェーズ

影響範囲が不明確、または判断を要する変更については、実装前に以下を簡潔に提示すること。

- 変更の目的
- 想定される影響範囲
- 代替案がある場合はその比較
- 不確実な点、または判断が必要な点

明示的な「進めてよい」という指示があるまで、実装してはならない。

### レビュー観点（自己チェック）

- 他の書き方と比較して、本当に読みやすいか
- 初見の開発者が意図を理解できるか
- なぜこの実装なのかが、コードから読み取れるか

## コマンド

コマンド実行前に、内容と影響範囲を確認すること。  
DBマイグレーション系のコマンドは明示的な指示がない限り実行してはならない。

- `npm run build`: プロジェクトのビルド
- `npm run format`: コード整形実行
- `npm run generate:i18n-types`: json形式の言語ファイルからTypeScript型定義を作成
- `npm run generate:openapi`: TypeScriptで記述されたOpenAPI情報からOpenAPIファイルを作成
- `npm run generate:openapi-types`: OpenAPIファイルからTypeScript型定義を作成
- `npm run generate:auth-schema`: better-auth設定からスキーマ情報生成
- `npm run generate:migration`: DBマイグレーションファイル作成
- `npm run dev:migrate`: DBマイグレーション実行
- `npx tsc`: TypeScript型チェック実行
- `npx exlint`: ESLintチェック実行
- `npm run test`: 単体テスト実行（全体）
- `npx vitest run <targetFilePath>`: 単体テスト実行（ファイル指定） 

## アーキテクチャ

AGENTは以下を**必ず（MUST）**前提としてコードを生成・修正すること。

- コーディング規約: [docs/architectures/code.md](docs/architectures/code.md)を参照
- ディレクトリ構成: [docs/architectures/directory.md](docs/architectures/directory.md)を参照

## テスト方針

AGENT は以下の方針に従ってテストを追加・修正すること。

### 粒度

- 単体テストを基本とする
- 1テストケースは「1つの振る舞い」を検証する
- 内部実装ではなく、公開インターフェースや振る舞いを検証する

### 対象

- 重要な分岐・エッジケースは必ずテストする
- バグ修正時は、再発防止のテストを必ず追加する
- 既存テストがある場合は、そのスタイル・粒度を優先する

### 禁止事項

- 実装詳細に強く依存するテストを書かない
- 不安定なテスト（時間依存・乱数依存・環境依存）を書かない
  - 時間に依存する処理は、タイマーのモック等を用いて制御する
- 不要に網羅率だけを目的としたテストを追加しない

### 外部依存

- DB や外部サービスに依存する処理は、可能な限りモックまたはスタブを使用する
- 実 DB を使用するテストは、明示的な指示がある場合のみ追加する

### 配置

- テストファイルの配置・命名規則は既存構成に従う
  - 既存ルールがない場合は、テスト対象ファイルが存在するディレクトリ内に `_tests` ディレクトリを作成し、その中に配置する
- 新規追加時は、対象ファイルと対応関係が分かる場所に配置する

### 実行

- 変更範囲が限定的な場合は、対象ファイルのみテストを実行する
- 全体への影響がある場合は、全テストを実行する

## Commit

### Commit の分割方針

AGENT は以下の基準に従って、必要に応じて複数コミットを作成すること。

#### 基本原則

- 変更の目的（why）が異なる場合は、必ずコミットを分ける
- 単独で revert 可能な変更単位を 1 コミットとする

#### 分割すべきケース

- 実装変更とテスト変更
- リファクタリングと振る舞い変更
- フォーマット・lint 修正とロジック変更
- 依存関係のない複数機能の変更

#### 例外

- 小規模なバグ修正で、テストが密接に結合している場合は同一コミット可

#### サイズ目安

- 1コミットあたり:
  - 変更行数: 200行以内
  - ファイル数: 5ファイル以内
- あくまで目安とし、意味的なまとまりを優先する

### Commit 前の自己レビュー

AGENT は各コミットを作成する前に、以下の観点で自己レビューを行うこと。

#### 必須チェック項目

- [ ] コミットの目的は 1 つに絞られているか
- [ ] 不要な変更（debug code / console.log / コメントアウト）が含まれていないか
- [ ] フォーマット変更とロジック変更が混在していないか
- [ ] テストの意図が実装と一致しているか
- [ ] 命名は既存の規約・文脈と整合しているか

#### 差分品質チェック

- [ ] このコミット単体でビルド・テストが通るか
- [ ] revert しても他の変更に影響しないか
- [ ] レビュー時に「何を見ればよいか」が明確か

### Commit 前の差分要約

AGENT はコミットを作成する前に、以下の要約を内部的に作成し、
要約内容と一致する最小単位でコミットを切ること。

#### 要約フォーマット（内部用）

- 変更目的:
- 主な変更点:
- 影響範囲:
- レビュー観点:

#### ルール

- 要約が 1 つにまとまらない場合は、コミットを分割する
- 要約と Commit message の内容は一致していること

### Commit message 規約

AGENT は以下の規約に従ってコミットメッセージを作成すること。

#### 基本形式

- 1行目は変更内容を簡潔に要約する
- 要約は日本語で記述する
- 文末に句点は付けない

#### type 一覧

- `feat`: 新機能の追加
- `fix`: バグ修正
- `refactor`: 振る舞いを変えない内部構造の変更
- `test`: テストの追加・修正
- `docs`: ドキュメントのみの変更
- `chore`: ビルド・設定・生成物などの変更
- `ci`: CI / GitHub Actions 関連の変更

#### ルール

- 1コミットにつき、1つの目的に集中する
- 無関係な変更を同一コミットに含めない
- フォーマット修正のみの場合は `chore` を使用する
- テストのみの変更は `test` を使用する

#### NG 例

- `fix: 修正`
- `feat: いろいろ対応`
- `update`

## プルリクエスト

### 必須記載事項

プルリクエストは[.github/pull_request_template.md](./.github/pull_request_template.md)を**必ず（MUST）**参考に作成すること。

### テストとの関係

- テストを追加・修正した場合は明記する
- テストを追加していない場合は理由を記載する

### スコープ

- 1プルリクエストにつき、1つの目的に集中する
- 無関係なリファクタ・フォーマット変更を含めない

### コードレビュールール

- 簡潔で分かりやすい説明を心がける
- 必要に応じてコードサンプルを含める

### レビュー対応

- must 指摘は最優先で必ず対応する
- nits / imo は内容を理解したうえで対応可否を判断する
- ask には、必ず回答する

#### バッジの使用

レビューの内容に応じて、以下のバッジを使用して分類する。

- 変更必須事項: ![must](https://img.shields.io/badge/review-must-darkred.svg)
- 指摘事項: ![nits](https://img.shields.io/badge/review-nits-darkgreen.svg)
- 変更任意事項: ![imo-badge](https://img.shields.io/badge/review-imo-orange.svg)
- 質問事項: ![ask](https://img.shields.io/badge/review-ask-blue.svg)
- メモ: ![badge](https://img.shields.io/badge/note-lightgray.svg)
